#!/bin/bash
echo "сбор данных для отчета..."
echo "размер массива,потоки,время_посл,время_редукции,время_критич,ускорение_редукции,ускорение_критич" > results_fixed.csv

# улучшенная версия сбора данных с обработкой ошибок
for size in 1000 10000 100000 1000000 10000000; do
    echo "размер: $size"
    OMP_NUM_THREADS=4 ./min_max $size 2>&1 | awk -v size=$size '
    # улучшенный awk скрипт для парсинга всех трех версий
    /последовательная версия:/ {
        getline
        if ($1 == "минимум:") {  # проверяем корректность данных
            getline
            seq_time = $3  # время последовательной версии
        }
    }
    /параллельная версия \(редукция\):/ {
        getline
        if ($1 == "минимум:") {
            getline
            red_time = $3  # время версии с редукцией
            getline
            split($3, arr, "x")  # разделяем строку ускорения
            red_speed = arr[1]   # извлекаем числовое значение ускорения
        }
    }
    /параллельная версия \(критические секции\):/ {
        getline
        if ($1 == "минимум:") {
            getline
            crit_time = $3  # время версии с критическими секциями
            getline
            split($3, arr, "x")  # разделяем строку ускорения
            crit_speed = arr[1]   # извлекаем числовое значение ускорения
        }
    }
    END {
        # записываем только если все данные корректны
        if (seq_time && red_time && crit_time) {
            print size ",4," seq_time "," red_time "," crit_time "," red_speed "," crit_speed
        }
    }' >> results_fixed.csv
done

echo "данные сохранены в results_fixed.csv"
